<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID Detector</title>
</head>

<body>
    <h1>ID Convertor</h1>
    <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data">
        <input type="file" name="avatar" id="avatarInput" />
        <button type="button" onclick="submitForm()">Convert</button>
    </form>

    <h2>Result:</h2>
    <div id="jsonOutput"></div>

    <h2>Uploaded Images:</h2>
    <div id="imageContainer"></div>


    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        function submitForm() {
            const fileInput = document.getElementById('avatarInput');
            const maxFileSizeMB = 2;
            if (fileInput.files.length > 0 && fileInput.files[0].size > maxFileSizeMB * 1024 * 1024) {
                alert('File size exceeds the limit. Please choose a file smaller than 2 MB.');
                return;
            }

            const formData = new FormData(document.getElementById('uploadForm'));

            $.ajax({
                type: 'POST',
                url: '/upload',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    displayJsonOutput(response);
                },
                error: function (error) {
                    console.error('Error:', error);
                    alert('Error processing file. Please try again.');
                }
            });
        }

        function displayJsonOutput(jsonData) {
            const jsonOutputElement = $('#jsonOutput');
            jsonOutputElement.empty(); // Clear previous content

            const jsonText = JSON.stringify(jsonData, null, 2);
            const lines = jsonText.split('\n');

            lines.forEach((line) => {
                const formattedLine = $('<div></div>').text(line);
                jsonOutputElement.append(formattedLine);
            });

            // Display the image link if available in the response
            if (jsonData.imageLink) {
                const imageLink = $('<img>').attr('src', jsonData.imageLink).attr('alt', 'Processed Image');
                jsonOutputElement.append('<h3>Processed Image:</h3>', imageLink);
            }
        }
        $(document).ready(function () {
            // Fetch images when the page loads
            fetchImages();

            // Function to fetch and display images
            function fetchImages() {
                $.ajax({
                    type: 'GET',
                    url: '/images',
                    success: function (images) {
                        const imageContainer = $('#imageContainer');
                        imageContainer.empty(); // Clear previous content

                        images.forEach((image) => {
                            // Create a div for each image
                            const imageDiv = $('<div></div>');
                            console.log(image.img.data.toString())
                            // Display the image
                            const imageElement = $('<img>').attr('src', 'data:' + image.img.contentType + ';base64,' + btoa(image.img.data)).attr('alt', 'Uploaded Image');
                            imageDiv.append(imageElement);
                            // Display the message
                            const messageElement = $('<p></p>').text('Message: ' + image.desc);
                            imageDiv.append(messageElement);

                            // Append the image div to the container
                            imageContainer.append(imageDiv);
                        });
                    },
                    error: function (error) {
                        console.error('Error retrieving images:', error);
                        alert('Error retrieving images. Please try again.');
                    }
                });
            }
        });
    </script>
</body>

</html>